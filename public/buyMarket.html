<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ซื้อทันที (Buy Now)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="fixed top-0 left-0 right-0 h-14 bg-white/80 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto h-full flex items-center justify-between px-4">
      <a href="/home.html" class="text-sm text-slate-600 hover:text-slate-900">← กลับหน้าหลัก</a>
      <div class="text-right">
        <button id="logout" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:opacity-95">ออกจากระบบ</button>
        <div class="mt-1 text-[12px] text-slate-600">
          <span class="mr-1 text-slate-400">Address:</span>
          <code id="addr" class="bg-slate-100 rounded px-2 py-0.5 break-all">—</code>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-20 pb-16">
    <div class="max-w-5xl mx-auto px-4 space-y-6">
      <h1 class="text-xl font-semibold">ซื้อทันทีจากออร์เดอร์ SELL ที่เปิดอยู่</h1>
      <div class="flex flex-wrap items-end gap-3 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">Base</label>
          <select id="fltBase" class="border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Quote</label>
          <select id="fltQuote" class="border rounded-xl px-3 py-2"></select>
        </div>
        <button id="btnReload" class="px-4 py-2 rounded-xl border hover:bg-slate-50">โหลดรายการ</button>
        <button id="btnAll" class="px-4 py-2 rounded-xl border hover:bg-slate-50">ทั้งหมด (All)</button>
      </div>
      <div class="overflow-auto bg-white rounded-2xl shadow-sm p-6">
        <table class="w-full text-sm">
          <thead class="text-left text-slate-500">
            <tr>
              <th class="py-2 pr-3">เวลา</th>
              <th class="py-2 pr-3">ผู้ขาย</th>
              <th class="py-2 pr-3">คู่</th>
              <th class="py-2 pr-3">จำนวน (Base)</th>
              <th class="py-2 pr-3">คงเหลือ</th>
              <th class="py-2 pr-3">ราคา</th>
              <th class="py-2">ซื้อจาก</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 hidden">
    <div id="toastBox" class="px-3 py-2 rounded-lg shadow bg-slate-900 text-white text-sm"></div>
  </div>
<div id="buyModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="w-[420px] max-w-[92vw] bg-white rounded-2xl shadow p-5">
    <h3 class="text-lg font-semibold mb-3">ซื้อจากคำสั่งขาย</h3>

    <div class="text-sm space-y-1 mb-3">
      <div>คำสั่ง: <code id="bOrderId" class="text-slate-600"></code></div>
      <div>คู่: <span id="bPair" class="font-medium"></span></div>
      <div>ราคาต่อ 1 <span id="bBaseCodePx"></span>: <span id="bPrice"></span></div>
      <div>คงเหลือที่ผู้ขายเสนอ: <span id="bRemain" class="font-medium"></span></div>
      <div>กระเป๋าของฉัน (<span id="bQuoteCode"></span>) — Available: 
        <span id="bAvail" class="font-medium"></span>
      </div>
    </div>

    <label class="block text-sm font-medium mb-1">จำนวนที่จะซื้อ (<span id="bBaseCode2"></span>)</label>
    <div class="flex gap-2">
      <input id="bAmount" type="number" min="0" step="any"
             class="flex-1 border rounded-xl px-3 py-2" placeholder="กรอกจำนวน" />
      <button id="bMax">MAX</button>
    </div>

    <div class="flex justify-end gap-2 mt-4">
      <button id="bCancel" class="px-4 py-2 rounded-xl border">ยกเลิก</button>
      <button id="bConfirm" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">ยืนยันซื้อ</button>
    </div>
  </div>
</div>
  <script>
    const apiBase = "/api";
    const LIST_SELL_URL = `${apiBase}/orders/sell-open`;
    const BUY_NOW_URL = (orderId) => `${apiBase}/orders/${orderId}/buy`;
    const WALLET_BAL_URL = (addr, asset) =>
  `${apiBase}/wallet/${addr}/balance${asset ? `?asset=${encodeURIComponent(asset)}` : ''}`;
    let buyCtx = null;
    const address = sessionStorage.getItem('p2p.address') || '';
    if (!address) location.replace('/');
    const $ = id => document.getElementById(id);
    $('addr').textContent = address;

    const toast = (m, ok=true) => {
      const b = $('toastBox'), t = $('toast');
      b.textContent = m;
      b.className = 'px-3 py-2 rounded-lg shadow text-sm ' + (ok ? 'bg-emerald-600' : 'bg-rose-600');
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1800);
    };

    const fltBase = $('fltBase');
    const fltQuote = $('fltQuote');

    const ASSETS = ['BTC','USDT','THB','ETH','XRP','ADA','DOGE','AVAX'];
    function fillAssetSelect(sel, includeAll = false) {
      sel.innerHTML = '';
      if (includeAll) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = 'ทั้งหมด';
        sel.appendChild(opt);
      }
      ASSETS.forEach(code => {
        const o = document.createElement('option');
        o.value = code;
        o.textContent = code;
        sel.appendChild(o);
      });
    }

    fillAssetSelect(fltBase, true);
    fillAssetSelect(fltQuote, true);
    const orderCache = new Map();
    async function loadList() {
      const params = new URLSearchParams();
      if (fltBase.value)  params.set('base', fltBase.value);
      if (fltQuote.value) params.set('quote', fltQuote.value);

try {
  const res = await fetch(`${LIST_SELL_URL}?${params.toString()}`);
  const j = await res.json();
  if (!res.ok || j.error) return toast(j.error || 'โหลดไม่สำเร็จ', false);

  orderCache.clear(); // ✅ เคลียร์ก่อน
  j.forEach(o => {
    orderCache.set(o.orderId, o); // ✅ เก็บลง cache
  });

  const html = j.map(o => {
    const remain = parseFloat(o.amountBase) - parseFloat(o.amountBaseFilled || 0);
    const showBtn = o.ownerAddress !== address && o.status === 'OPEN' && remain > 0;
    const btn = showBtn
      ? `<button data-id="${o.orderId}" data-remain="${remain}"
               class="buyBtn px-2 py-1 rounded bg-emerald-600 text-white text-sm hover:opacity-90">
           ซื้อจาก
         </button>`
      : '-';

    return `
      <tr class="border-t">
        <td class="py-2 pr-3">${new Date(o.createdAt).toLocaleString()}</td>
        <td class="py-2 pr-3"><code class="text-xs">${o.ownerAddress}</code></td>
        <td class="py-2 pr-3">${o.baseAsset}/${o.quoteAsset}</td>
        <td class="py-2 pr-3">${o.amountBase}</td>
        <td class="py-2 pr-3">${remain}</td>
        <td class="py-2 pr-3">${o.price}</td>
        <td class="py-2">${btn}</td>
      </tr>`;
  }).join('');

  $('rows').innerHTML = html || `<tr><td colspan="7" class="py-3 text-center text-slate-500">ไม่มีออร์เดอร์ SELL ที่เปิดอยู่</td></tr>`;

  // ✅ Event listener
  document.querySelectorAll('.buyBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orderId = btn.getAttribute('data-id');
      const remain = parseFloat(btn.getAttribute('data-remain'));
      const order = orderCache.get(orderId);
      if (!order) return toast('ไม่พบคำสั่งขาย', false);
      openBuyModal(order, remain);
    });
  });

} catch {
  toast('โหลดรายการไม่สำเร็จ', false);
}
    }


function openBuyModal(order, remain) {
  buyCtx = { order, remain, submitting: false };

  $('bOrderId').textContent = order.orderId;
  $('bPair').textContent = `${order.baseAsset}/${order.quoteAsset}`;
  $('bBaseCodePx').textContent = order.baseAsset;
  $('bBaseCode2').textContent = order.baseAsset;
  $('bQuoteCode').textContent = order.quoteAsset;
  $('bPrice').textContent = order.price;
  $('bRemain').textContent = remain;
  $('bAmount').value = '';

  $('buyModal').classList.remove('hidden');
  $('buyModal').classList.add('flex');

  const btnMax = $('bMax');
  btnMax.onclick = () => {
    const quoteAvail = buyCtx?.quoteAvail || 0;
    const price = parseFloat(order.price);
    const max = price > 0 ? Math.min(quoteAvail / price, remain) : 0;
    $('bAmount').value = max > 0 ? String(max.toFixed(6)) : '';
    console.log('[bMax] Clicked', { max });
  };

  // ✅ แล้วค่อยไปโหลด balance
  loadMyQuoteBalance(order.quoteAsset);
}


 function closeBuyModal() {
  $('buyModal').classList.add('hidden');
  $('buyModal').classList.remove('flex');
  buyCtx = null;
}

function loadMyQuoteBalance(assetCode) {
  fetch(WALLET_BAL_URL(address, assetCode))
    .then(res => res.json())
    .then(j => {
      if (j.error) throw new Error(j.error);

      const bal = (j.balances || [])[0] || {};
      const avail = parseFloat(bal.balanceAvailable || 0);
      const locked = parseFloat(bal.balanceLocked || 0);

      $('bAvail').textContent = String(avail);
      

      buyCtx.quoteAvail = avail;

      // ✅ ตั้ง onclick หลังได้ค่า balance แล้ว
      const btnMax = $('bMax');
      if (btnMax) {
        btnMax.onclick = () => {
          const quoteAvail = avail || 0;
          const price = parseFloat(buyCtx.order.price); // ใช้จาก buyCtx
          const remain = buyCtx.remain;
          const max = price > 0 ? Math.min(quoteAvail / price, remain) : 0;
          $('bAmount').value = max > 0 ? String(max.toFixed(6)) : '';
          console.log('[bMax] Clicked', { max });
        };
      }
    })
    .catch(e => {
      console.error('โหลด balance ล้มเหลว', e);
    });
}
$('bCancel').onclick = () => closeBuyModal();

$('bConfirm').onclick = async () => {
  if (!buyCtx || buyCtx.submitting) return;
  const amt = parseFloat($('bAmount').value || '0');
  if (!(amt > 0)) return toast('กรุณากรอกจำนวนที่ถูกต้อง', false);
  if (amt > buyCtx.remain) return toast('เกินจำนวนที่ผู้ขายเสนอ', false);

  const btn = $('bConfirm');
  btn.disabled = true;
  btn.textContent = 'กำลังซื้อ...';
  buyCtx.submitting = true;

  try {
    const res = await fetch(`/api/orders/${buyCtx.order.orderId}/buy`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ buyerAddress: address, amountBase: amt })
    });
    const j = await res.json();
    if (!res.ok || j.error) {
      toast(j.error || 'ซื้อไม่สำเร็จ', false);
    } else {
      toast(`ซื้อสำเร็จ: ${j.buySummary.buyFilledBase} ในราคา ${j.buySummary.price}`);
      closeBuyModal();
      loadList(); // reload table
    }
  } catch {
    toast('เชื่อมต่อเซิร์ฟเวอร์ไม่ได้', false);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ยืนยันซื้อ';
    buyCtx.submitting = false;
  }
};
    async function buyNow(orderId, maxBase) {
      const input = prompt(`คุณต้องการซื้อเท่าไหร่ (Max ${maxBase})?`);
      if (!input) return;
      const amt = parseFloat(input);
      if (!(amt > 0)) return toast('จำนวนไม่ถูกต้อง', false);
      if (amt > maxBase) return toast('มากกว่าจำนวนที่ผู้ขายเสนอ', false);

      try {
        const res = await fetch(BUY_NOW_URL(orderId), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ buyerAddress: address, amountBase: amt })
        });
        const j = await res.json();
        if (!res.ok || j.error) return toast(j.error || 'ซื้อไม่สำเร็จ', false);
        toast(`ซื้อสำเร็จ: ${j.buySummary.buyFilledBase} ในราคา ${j.buySummary.price}`);
        loadList();
      } catch {
        toast('เชื่อมต่อเซิร์ฟเวอร์ไม่ได้', false);
      }
    }

    $('logout').onclick = () => {
      sessionStorage.clear();
      location.replace('/index.html');
    };
    $('btnReload').onclick = loadList;
    $('btnAll').onclick = () => {
      fltBase.value = '';
      fltQuote.value = '';
      loadList();
    };

    fltBase.addEventListener('change', loadList);
    fltQuote.addEventListener('change', loadList);

    loadList();
  </script>
</body>
</html>
